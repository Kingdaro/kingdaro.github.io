{"version":3,"sources":["webpack:///build.js","webpack:///webpack/bootstrap 7a1fd5f41afdb69d3074","webpack:///./src/Entity.ts","webpack:///./src/math.ts","webpack:///./src/animation.ts","webpack:///./src/loaders.ts","webpack:///./src/main.ts","webpack:///./src/Camera.ts","webpack:///./src/entities.ts","webpack:///./src/entities/Mario.ts","webpack:///./src/traits/Go.ts","webpack:///./src/traits/Jump.ts","webpack:///./src/layers.ts","webpack:///./src/Level.ts","webpack:///./src/Compositor.ts","webpack:///./src/TileCollider.ts","webpack:///./src/TileResolver.ts","webpack:///./src/SpriteSheet.ts","webpack:///./src/input.ts","webpack:///./src/Keyboard.ts","webpack:///./src/Timer.ts"],"names":["modules","__webpack_require__","moduleId","installedModules","exports","module","i","l","call","m","c","d","name","getter","o","Object","defineProperty","configurable","enumerable","get","n","__esModule","object","property","prototype","hasOwnProperty","p","s","value","math_1","Side","Trait","NAME","this","obstruct","entity","side","Entity","pos","Vec2","vel","size","traits","addTrait","trait","push","getTrait","find","Error","update","deltaTime","_this","forEach","x","y","set","Matrix","grid","col","callback","column","createAnimation","frames","frameLength","distance","frameIndex","Math","floor","length","loadImage","url","Promise","resolve","reject","image","Image","addEventListener","event","src","loadJSON","fetch","then","res","json","createTiles","level","backgrounds","applyRange","background","xStart","xLength","yStart","yLength","xEnd","yEnd","tiles","sprite","type","ranges","range","loadSpriteSheet","__awaiter","sheetSpec","sprites","__generator","_a","label","sent","imageURL","SpriteSheet_1","SpriteSheet","tileW","tileH","tileSpec","index","defineTile","frameSpec","rect","width","height","define","animations","animSpec","animation","animation_1","defineAnimation","loadLevel","levelSpec","backgroundSprites","backgroundLayer","spriteLayer","spriteSheet","Level_1","Level","layers_1","createBackgroundLayer","comp","layers","createSpriteLayer","entities","thisArg","_arguments","P","generator","fulfilled","step","next","e","rejected","result","done","apply","body","verb","v","op","f","TypeError","_","t","ops","pop","trys","g","throw","return","Symbol","iterator","drawControls","context","text","lines","split","save","font","textAlign","textBaseline","fillStyle","line","offset","fillText","restore","Camera_1","entities_1","input_1","loaders_1","Timer_1","canvas","mario","camera","input","checkGamepadInput","timer","_b","document","getElementById","getContext","all","createMario","Camera","imageSmoothingEnabled","mozImageSmoothingEnabled","webkitImageSmoothingEnabled","add","setupKeyboard","listenTo","window","setupGamepad","Timer","scale","draw","start","catch","console","error","Mario_1","Mario","bind","__extends","extendStatics","setPrototypeOf","__proto__","Array","b","__","constructor","create","Entity_1","Go_1","Jump_1","SLOW_DRAG","_super","jump","Jump","go","Go","runAnimation","dragFactor","resolveAnimationFrame","falling","dir","heading","turbo","turboState","acceleration","deceleration","absX","abs","decel","min","sign","drag","duration","velocity","engageTime","ready","requestTime","gracePeriod","speedBoost","cancel","bottom","top","drawTiles","drawFrom","drawTo","startIndex","endIndex","tile","has","drawAnimation","totalTime","drawTile","tileResolver","tileCollider","buffer","createElement","drawWidth","toIndex","drawImage","spriteBuffer","spriteBufferContext","clearRect","createCollisionLayer","tileSize","resolvedTiles","getByIndexOriginal","getByIndex","strokeStyle","strokeRect","splice","createCameraLayer","cameraToDraw","fromCamera","Compositor_1","TileCollider_1","Compositor","Set","TileCollider","gravity","checkX","checkY","layer","TileResolver_1","tileMatrix","TileResolver","matches","searchByRange","match","x1","x2","y1","y2","matrix","toIndexRange","pos1","pos2","pMax","ceil","indexX","indexY","searchByPosition","posX","posY","tileWidth","tileHeight","Map","buffers","map","flipped","translate","flip","doJump","pressed","moveRight","keyState","moveLeft","run","Keyboard_1","Keyboard","addListener","gamepad","navigator","getGamepads","movementAxis","axes","jumping","buttons","running","keyStates","keyListeners","code","target","eventName","handleEvent","repeat","listener","preventDefault","accumulatedTime","lastTime","dt","updateProxy","time","enqueue","requestAnimationFrame"],"mappings":"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","file":"build.js","sourcesContent":["/******/ (function(modules) { // webpackBootstrap\n/******/ \t// The module cache\n/******/ \tvar installedModules = {};\n/******/\n/******/ \t// The require function\n/******/ \tfunction __webpack_require__(moduleId) {\n/******/\n/******/ \t\t// Check if module is in cache\n/******/ \t\tif(installedModules[moduleId]) {\n/******/ \t\t\treturn installedModules[moduleId].exports;\n/******/ \t\t}\n/******/ \t\t// Create a new module (and put it into the cache)\n/******/ \t\tvar module = installedModules[moduleId] = {\n/******/ \t\t\ti: moduleId,\n/******/ \t\t\tl: false,\n/******/ \t\t\texports: {}\n/******/ \t\t};\n/******/\n/******/ \t\t// Execute the module function\n/******/ \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n/******/\n/******/ \t\t// Flag the module as loaded\n/******/ \t\tmodule.l = true;\n/******/\n/******/ \t\t// Return the exports of the module\n/******/ \t\treturn module.exports;\n/******/ \t}\n/******/\n/******/\n/******/ \t// expose the modules object (__webpack_modules__)\n/******/ \t__webpack_require__.m = modules;\n/******/\n/******/ \t// expose the module cache\n/******/ \t__webpack_require__.c = installedModules;\n/******/\n/******/ \t// define getter function for harmony exports\n/******/ \t__webpack_require__.d = function(exports, name, getter) {\n/******/ \t\tif(!__webpack_require__.o(exports, name)) {\n/******/ \t\t\tObject.defineProperty(exports, name, {\n/******/ \t\t\t\tconfigurable: false,\n/******/ \t\t\t\tenumerable: true,\n/******/ \t\t\t\tget: getter\n/******/ \t\t\t});\n/******/ \t\t}\n/******/ \t};\n/******/\n/******/ \t// getDefaultExport function for compatibility with non-harmony modules\n/******/ \t__webpack_require__.n = function(module) {\n/******/ \t\tvar getter = module && module.__esModule ?\n/******/ \t\t\tfunction getDefault() { return module['default']; } :\n/******/ \t\t\tfunction getModuleExports() { return module; };\n/******/ \t\t__webpack_require__.d(getter, 'a', getter);\n/******/ \t\treturn getter;\n/******/ \t};\n/******/\n/******/ \t// Object.prototype.hasOwnProperty.call\n/******/ \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n/******/\n/******/ \t// __webpack_public_path__\n/******/ \t__webpack_require__.p = \"\";\n/******/\n/******/ \t// Load entry module and return exports\n/******/ \treturn __webpack_require__(__webpack_require__.s = 4);\n/******/ })\n/************************************************************************/\n/******/ ([\n/* 0 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar math_1 = __webpack_require__(1);\r\nvar Side;\r\n(function (Side) {\r\n    Side[Side[\"top\"] = 0] = \"top\";\r\n    Side[Side[\"bottom\"] = 1] = \"bottom\";\r\n})(Side = exports.Side || (exports.Side = {}));\r\nvar Trait = /** @class */ (function () {\r\n    function Trait(NAME) {\r\n        this.NAME = NAME;\r\n    }\r\n    Trait.prototype.obstruct = function (entity, side) { };\r\n    return Trait;\r\n}());\r\nexports.Trait = Trait;\r\nvar Entity = /** @class */ (function () {\r\n    function Entity() {\r\n        this.pos = new math_1.Vec2(0, 0);\r\n        this.vel = new math_1.Vec2(0, 0);\r\n        this.size = new math_1.Vec2(0, 0);\r\n        this.traits = [];\r\n    }\r\n    Entity.prototype.addTrait = function (trait) {\r\n        this.traits.push(trait);\r\n    };\r\n    Entity.prototype.getTrait = function (name) {\r\n        var trait = this.traits.find(function (trait) { return trait.NAME === name; });\r\n        if (!trait)\r\n            throw new Error('Trait not found:' + name);\r\n        return trait;\r\n    };\r\n    Entity.prototype.update = function (deltaTime) {\r\n        var _this = this;\r\n        this.traits.forEach(function (trait) {\r\n            trait.update(_this, deltaTime);\r\n        });\r\n    };\r\n    Entity.prototype.obstruct = function (side) {\r\n        var _this = this;\r\n        this.traits.forEach(function (trait) {\r\n            trait.obstruct(_this, side);\r\n        });\r\n    };\r\n    return Entity;\r\n}());\r\nexports.Entity = Entity;\r\n\n\n/***/ }),\n/* 1 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar Vec2 = /** @class */ (function () {\r\n    function Vec2(x, y) {\r\n        this.x = x;\r\n        this.y = y;\r\n    }\r\n    Vec2.prototype.set = function (x, y) {\r\n        this.x = x;\r\n        this.y = y;\r\n    };\r\n    return Vec2;\r\n}());\r\nexports.Vec2 = Vec2;\r\nvar Matrix = /** @class */ (function () {\r\n    function Matrix() {\r\n        this.grid = [];\r\n    }\r\n    Matrix.prototype.set = function (x, y, value) {\r\n        if (!this.grid[x]) {\r\n            this.grid[x] = [];\r\n        }\r\n        this.grid[x][y] = value;\r\n    };\r\n    Matrix.prototype.get = function (x, y) {\r\n        var col = this.grid[x];\r\n        if (col)\r\n            return col[y];\r\n    };\r\n    Matrix.prototype.forEach = function (callback) {\r\n        this.grid.forEach(function (column, x) {\r\n            column.forEach(function (value, y) {\r\n                callback(value, x, y);\r\n            });\r\n        });\r\n    };\r\n    return Matrix;\r\n}());\r\nexports.Matrix = Matrix;\r\n\n\n/***/ }),\n/* 2 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nfunction createAnimation(frames, frameLength) {\r\n    return function resolveFrame(distance) {\r\n        var frameIndex = Math.floor((distance / frameLength) % frames.length);\r\n        return frames[frameIndex];\r\n    };\r\n}\r\nexports.createAnimation = createAnimation;\r\n\n\n/***/ }),\n/* 3 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nvar __generator = (this && this.__generator) || function (thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = y[op[0] & 2 ? \"return\" : op[0] ? \"throw\" : \"next\"]) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [0, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar animation_1 = __webpack_require__(2);\r\nvar layers_1 = __webpack_require__(10);\r\nvar Level_1 = __webpack_require__(11);\r\nvar SpriteSheet_1 = __webpack_require__(15);\r\nfunction loadImage(url) {\r\n    return new Promise(function (resolve, reject) {\r\n        var image = new Image();\r\n        image.addEventListener('load', function () {\r\n            resolve(image);\r\n        });\r\n        image.addEventListener('error', function (event) {\r\n            reject(\"Could not load image from \" + url);\r\n        });\r\n        image.src = url;\r\n    });\r\n}\r\nexports.loadImage = loadImage;\r\nfunction loadJSON(url) {\r\n    return fetch(url).then(function (res) { return res.json(); });\r\n}\r\nfunction createTiles(level, backgrounds) {\r\n    function applyRange(background, xStart, xLength, yStart, yLength) {\r\n        var xEnd = xStart + xLength;\r\n        var yEnd = yStart + yLength;\r\n        for (var x = xStart; x < xEnd; x++) {\r\n            for (var y = yStart; y < yEnd; y++) {\r\n                level.tiles.set(x, y, {\r\n                    name: background.sprite,\r\n                    type: background.type,\r\n                });\r\n            }\r\n        }\r\n    }\r\n    backgrounds.forEach(function (background) {\r\n        background.ranges.forEach(function (range) {\r\n            if (range.length === 4) {\r\n                var xStart = range[0], xLength = range[1], yStart = range[2], yLength = range[3];\r\n                applyRange(background, xStart, xLength, yStart, yLength);\r\n            }\r\n            else if (range.length === 3) {\r\n                var xStart = range[0], xLength = range[1], yStart = range[2];\r\n                applyRange(background, xStart, xLength, yStart, 1);\r\n            }\r\n            else if (range.length === 2) {\r\n                var xStart = range[0], yStart = range[1];\r\n                applyRange(background, xStart, 1, yStart, 1);\r\n            }\r\n        });\r\n    });\r\n}\r\nfunction loadSpriteSheet(name) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var url, sheetSpec, image, sprites;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0:\r\n                    url = \"/public/sprites/\" + name + \".json\";\r\n                    return [4 /*yield*/, loadJSON(url)];\r\n                case 1:\r\n                    sheetSpec = _a.sent();\r\n                    return [4 /*yield*/, loadImage(sheetSpec.imageURL)];\r\n                case 2:\r\n                    image = _a.sent();\r\n                    sprites = new SpriteSheet_1.SpriteSheet(image, sheetSpec.tileW, sheetSpec.tileH);\r\n                    if (sheetSpec.tiles) {\r\n                        sheetSpec.tiles.forEach(function (tileSpec) {\r\n                            var _a = tileSpec.index, x = _a[0], y = _a[1];\r\n                            sprites.defineTile(tileSpec.name, x, y);\r\n                        });\r\n                    }\r\n                    if (sheetSpec.frames) {\r\n                        sheetSpec.frames.forEach(function (frameSpec) {\r\n                            var _a = frameSpec.rect, x = _a[0], y = _a[1], width = _a[2], height = _a[3];\r\n                            sprites.define(frameSpec.name, x, y, width, height);\r\n                        });\r\n                    }\r\n                    if (sheetSpec.animations) {\r\n                        sheetSpec.animations.forEach(function (animSpec) {\r\n                            var animation = animation_1.createAnimation(animSpec.frames, animSpec.frameLength);\r\n                            sprites.defineAnimation(animSpec.name, animation);\r\n                        });\r\n                    }\r\n                    return [2 /*return*/, sprites];\r\n            }\r\n        });\r\n    });\r\n}\r\nexports.loadSpriteSheet = loadSpriteSheet;\r\nfunction loadLevel(name) {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var levelSpec, backgroundSprites, level, backgroundLayer, spriteLayer;\r\n        return __generator(this, function (_a) {\r\n            switch (_a.label) {\r\n                case 0: return [4 /*yield*/, loadJSON(\"/public/levels/\" + name + \".json\")];\r\n                case 1:\r\n                    levelSpec = _a.sent();\r\n                    return [4 /*yield*/, loadSpriteSheet(levelSpec.spriteSheet)];\r\n                case 2:\r\n                    backgroundSprites = _a.sent();\r\n                    level = new Level_1.Level();\r\n                    createTiles(level, levelSpec.backgrounds);\r\n                    backgroundLayer = layers_1.createBackgroundLayer(level, backgroundSprites);\r\n                    level.comp.layers.push(backgroundLayer);\r\n                    spriteLayer = layers_1.createSpriteLayer(level.entities);\r\n                    level.comp.layers.push(spriteLayer);\r\n                    return [2 /*return*/, level];\r\n            }\r\n        });\r\n    });\r\n}\r\nexports.loadLevel = loadLevel;\r\n\n\n/***/ }),\n/* 4 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nvar __generator = (this && this.__generator) || function (thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = y[op[0] & 2 ? \"return\" : op[0] ? \"throw\" : \"next\"]) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [0, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar Camera_1 = __webpack_require__(5);\r\nvar entities_1 = __webpack_require__(6);\r\nvar input_1 = __webpack_require__(16);\r\nvar loaders_1 = __webpack_require__(3);\r\nvar Timer_1 = __webpack_require__(18);\r\nfunction main() {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var canvas, context, _a, mario, level, camera, input, checkGamepadInput, timer;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    canvas = document.getElementById('screen');\r\n                    context = canvas.getContext('2d');\r\n                    return [4 /*yield*/, Promise.all([entities_1.createMario(), loaders_1.loadLevel('1-1')])];\r\n                case 1:\r\n                    _a = _b.sent(), mario = _a[0], level = _a[1];\r\n                    camera = new Camera_1.Camera();\r\n                    context.imageSmoothingEnabled = false;\r\n                    context.mozImageSmoothingEnabled = false;\r\n                    context.webkitImageSmoothingEnabled = false;\r\n                    mario.pos.set(64, 64);\r\n                    level.entities.add(mario);\r\n                    input = input_1.setupKeyboard(mario);\r\n                    input.listenTo(window);\r\n                    checkGamepadInput = input_1.setupGamepad(mario);\r\n                    timer = new Timer_1.Timer();\r\n                    timer.update = function update(deltaTime) {\r\n                        level.update(deltaTime);\r\n                        if (mario.pos.x > 100) {\r\n                            camera.pos.x = mario.pos.x - 100;\r\n                        }\r\n                        checkGamepadInput();\r\n                        context.save();\r\n                        context.scale(3, 3);\r\n                        level.comp.draw(context, camera);\r\n                        context.restore();\r\n                        drawControls(context);\r\n                    };\r\n                    timer.start();\r\n                    return [2 /*return*/];\r\n            }\r\n        });\r\n    });\r\n}\r\n// TODO: consider turning into a text layer, maybe\r\nfunction drawControls(context) {\r\n    var text = \"\\n    Controls:\\n\\n      Keyboard:\\n        A - Move Left\\n        D - Move Right\\n        P - Jump\\n        O - Run\\n\\n      Gamepad:\\n        Left Stick - Move Left/Right\\n        A/B - Jump\\n        X/Y - Run\\n  \";\r\n    var lines = text.split(/[\\r\\n]/);\r\n    context.save();\r\n    context.font = '20px Roboto, sans-serif';\r\n    context.textAlign = 'left';\r\n    context.textBaseline = 'top';\r\n    context.fillStyle = 'white';\r\n    lines.forEach(function (line, index) {\r\n        var offset = index * 24;\r\n        context.fillText(line, 0, 0 + offset);\r\n    });\r\n    context.restore();\r\n}\r\nmain().catch(console.error);\r\n\n\n/***/ }),\n/* 5 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar math_1 = __webpack_require__(1);\r\nvar Camera = /** @class */ (function () {\r\n    function Camera() {\r\n        this.pos = new math_1.Vec2(0, 0);\r\n        this.size = new math_1.Vec2(256, 224);\r\n    }\r\n    return Camera;\r\n}());\r\nexports.Camera = Camera;\r\n\n\n/***/ }),\n/* 6 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nvar __generator = (this && this.__generator) || function (thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = y[op[0] & 2 ? \"return\" : op[0] ? \"throw\" : \"next\"]) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [0, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar Mario_1 = __webpack_require__(7);\r\nvar loaders_1 = __webpack_require__(3);\r\nfunction createMario() {\r\n    return __awaiter(this, void 0, void 0, function () {\r\n        var _a;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    _a = Mario_1.Mario.bind;\r\n                    return [4 /*yield*/, loaders_1.loadSpriteSheet('mario')];\r\n                case 1: return [2 /*return*/, new (_a.apply(Mario_1.Mario, [void 0, _b.sent()]))()];\r\n            }\r\n        });\r\n    });\r\n}\r\nexports.createMario = createMario;\r\n\n\n/***/ }),\n/* 7 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nvar __extends = (this && this.__extends) || (function () {\r\n    var extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n    return function (d, b) {\r\n        extendStatics(d, b);\r\n        function __() { this.constructor = d; }\r\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n    };\r\n})();\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar animation_1 = __webpack_require__(2);\r\nvar Entity_1 = __webpack_require__(0);\r\nvar Go_1 = __webpack_require__(8);\r\nvar Jump_1 = __webpack_require__(9);\r\nvar FAST_DRAG = 1 / 5000;\r\nvar SLOW_DRAG = 1 / 1000;\r\nvar Mario = /** @class */ (function (_super) {\r\n    __extends(Mario, _super);\r\n    function Mario(sprites) {\r\n        var _this = _super.call(this) || this;\r\n        _this.sprites = sprites;\r\n        _this.jump = new Jump_1.Jump();\r\n        _this.go = new Go_1.Go();\r\n        _this.runAnimation = animation_1.createAnimation(['run-1', 'run-2', 'run-3'], 8);\r\n        _this.size.set(14, 16);\r\n        _this.addTrait(_this.jump);\r\n        _this.addTrait(_this.go);\r\n        _this.go.dragFactor = SLOW_DRAG;\r\n        return _this;\r\n    }\r\n    Mario.prototype.resolveAnimationFrame = function () {\r\n        if (this.jump.falling) {\r\n            return 'jump';\r\n        }\r\n        if (this.go.distance > 0) {\r\n            if ((this.vel.x > 0 && this.go.dir < 0) ||\r\n                (this.vel.x < 0 && this.go.dir > 0)) {\r\n                return 'brake';\r\n            }\r\n            return this.runAnimation(this.go.distance);\r\n        }\r\n        return 'idle';\r\n    };\r\n    Mario.prototype.draw = function (context) {\r\n        this.sprites.draw(this.resolveAnimationFrame(), context, 0, 0, this.go.heading < 0);\r\n    };\r\n    Mario.prototype.turbo = function (turboState) {\r\n        this.go.dragFactor = turboState ? FAST_DRAG : SLOW_DRAG;\r\n    };\r\n    return Mario;\r\n}(Entity_1.Entity));\r\nexports.Mario = Mario;\r\n\n\n/***/ }),\n/* 8 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nvar __extends = (this && this.__extends) || (function () {\r\n    var extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n    return function (d, b) {\r\n        extendStatics(d, b);\r\n        function __() { this.constructor = d; }\r\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n    };\r\n})();\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar Entity_1 = __webpack_require__(0);\r\nvar Go = /** @class */ (function (_super) {\r\n    __extends(Go, _super);\r\n    function Go() {\r\n        var _this = _super.call(this, 'go') || this;\r\n        _this.dir = 0;\r\n        _this.acceleration = 400;\r\n        _this.distance = 0;\r\n        _this.heading = 1;\r\n        _this.dragFactor = 1 / 5000;\r\n        _this.deceleration = 300;\r\n        return _this;\r\n    }\r\n    Go.prototype.update = function (entity, deltaTime) {\r\n        var absX = Math.abs(entity.vel.x);\r\n        if (this.dir !== 0) {\r\n            entity.vel.x += this.acceleration * this.dir * deltaTime;\r\n            var jump = entity.getTrait('jump');\r\n            if (jump) {\r\n                if (jump.falling === false) {\r\n                    this.heading = this.dir;\r\n                }\r\n            }\r\n            else {\r\n                this.heading = this.dir;\r\n            }\r\n        }\r\n        else if (entity.vel.x !== 0) {\r\n            var decel = Math.min(absX, this.deceleration * deltaTime);\r\n            entity.vel.x += -Math.sign(entity.vel.x) * decel;\r\n        }\r\n        else {\r\n            this.distance = 0;\r\n        }\r\n        var drag = this.dragFactor * entity.vel.x * absX;\r\n        entity.vel.x -= drag;\r\n        this.distance += absX * deltaTime;\r\n    };\r\n    return Go;\r\n}(Entity_1.Trait));\r\nexports.Go = Go;\r\n\n\n/***/ }),\n/* 9 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nvar __extends = (this && this.__extends) || (function () {\r\n    var extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n    return function (d, b) {\r\n        extendStatics(d, b);\r\n        function __() { this.constructor = d; }\r\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n    };\r\n})();\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar Entity_1 = __webpack_require__(0);\r\nvar Jump = /** @class */ (function (_super) {\r\n    __extends(Jump, _super);\r\n    function Jump() {\r\n        var _this = _super.call(this, 'jump') || this;\r\n        _this.duration = 0.3;\r\n        _this.velocity = 200;\r\n        _this.engageTime = 0;\r\n        _this.ready = 0;\r\n        _this.requestTime = 0;\r\n        _this.gracePeriod = 0.1;\r\n        _this.speedBoost = 0.3;\r\n        return _this;\r\n    }\r\n    Jump.prototype.start = function () {\r\n        this.requestTime = this.gracePeriod;\r\n    };\r\n    Jump.prototype.cancel = function () {\r\n        this.engageTime = 0;\r\n        this.requestTime = 0;\r\n    };\r\n    Jump.prototype.update = function (entity, deltaTime) {\r\n        if (this.requestTime > 0) {\r\n            if (this.ready > 0) {\r\n                this.engageTime = this.duration;\r\n                this.requestTime = 0;\r\n            }\r\n            this.requestTime -= deltaTime;\r\n        }\r\n        if (this.engageTime > 0) {\r\n            entity.vel.y = -(this.velocity + Math.abs(entity.vel.x) * this.speedBoost);\r\n            this.engageTime -= deltaTime;\r\n        }\r\n        this.ready -= 1;\r\n    };\r\n    Jump.prototype.obstruct = function (entity, side) {\r\n        if (side === Entity_1.Side.bottom) {\r\n            this.ready = 1;\r\n        }\r\n        else if (side === Entity_1.Side.top) {\r\n            this.cancel();\r\n        }\r\n    };\r\n    Object.defineProperty(Jump.prototype, \"falling\", {\r\n        get: function () {\r\n            return this.ready < 0;\r\n        },\r\n        enumerable: true,\r\n        configurable: true\r\n    });\r\n    return Jump;\r\n}(Entity_1.Trait));\r\nexports.Jump = Jump;\r\n\n\n/***/ }),\n/* 10 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nfunction createBackgroundLayer(level, sprites) {\r\n    var tiles = level.tiles;\r\n    var tileResolver = level.tileCollider.tileResolver;\r\n    var buffer = document.createElement('canvas');\r\n    buffer.width = 256 + 16;\r\n    buffer.height = 240;\r\n    var context = buffer.getContext('2d');\r\n    var startIndex;\r\n    var endIndex;\r\n    function drawTiles(drawFrom, drawTo) {\r\n        // if (drawFrom === startIndex && drawTo === endIndex) return\r\n        startIndex = drawFrom;\r\n        endIndex = drawTo;\r\n        var _loop_1 = function (x) {\r\n            var col = tiles.grid[x];\r\n            if (col) {\r\n                col.forEach(function (tile, y) {\r\n                    if (sprites.animations.has(tile.name)) {\r\n                        sprites.drawAnimation(tile.name, context, x - startIndex, y, level.totalTime);\r\n                    }\r\n                    else {\r\n                        sprites.drawTile(tile.name, context, x - startIndex, y);\r\n                    }\r\n                });\r\n            }\r\n        };\r\n        for (var x = startIndex; x <= endIndex; x++) {\r\n            _loop_1(x);\r\n        }\r\n    }\r\n    return function drawBackgroundLayer(context, camera) {\r\n        var drawWidth = tileResolver.toIndex(camera.size.x);\r\n        var drawFrom = tileResolver.toIndex(camera.pos.x);\r\n        var drawTo = drawFrom + drawWidth;\r\n        drawTiles(drawFrom, drawTo);\r\n        context.drawImage(buffer, -camera.pos.x % 16, -camera.pos.y);\r\n    };\r\n}\r\nexports.createBackgroundLayer = createBackgroundLayer;\r\nfunction createSpriteLayer(entities, width, height) {\r\n    if (width === void 0) { width = 64; }\r\n    if (height === void 0) { height = 64; }\r\n    var spriteBuffer = document.createElement('canvas');\r\n    spriteBuffer.width = width;\r\n    spriteBuffer.height = height;\r\n    var spriteBufferContext = spriteBuffer.getContext('2d');\r\n    return function drawSpriteLayer(context, camera) {\r\n        entities.forEach(function (entity) {\r\n            spriteBufferContext.clearRect(0, 0, width, height);\r\n            entity.draw(spriteBufferContext);\r\n            context.drawImage(spriteBuffer, entity.pos.x - camera.pos.x, entity.pos.y - camera.pos.y);\r\n        });\r\n    };\r\n}\r\nexports.createSpriteLayer = createSpriteLayer;\r\nfunction createCollisionLayer(level) {\r\n    var tileResolver = level.tileCollider.tileResolver;\r\n    var tileSize = tileResolver.tileSize;\r\n    var resolvedTiles = [];\r\n    var getByIndexOriginal = tileResolver.getByIndex;\r\n    tileResolver.getByIndex = function getByIndexFake(x, y) {\r\n        resolvedTiles.push({ x: x, y: y });\r\n        return getByIndexOriginal.call(tileResolver, x, y);\r\n    };\r\n    return function drawCollision(context, camera) {\r\n        context.strokeStyle = 'blue';\r\n        resolvedTiles.forEach(function (_a) {\r\n            var x = _a.x, y = _a.y;\r\n            context.strokeRect(x * tileSize - camera.pos.x, y * tileSize - camera.pos.y, tileSize, tileSize);\r\n        });\r\n        level.entities.forEach(function (entity) {\r\n            context.strokeRect(entity.pos.x - camera.pos.x, entity.pos.y - camera.pos.y, entity.size.x, entity.size.y);\r\n        });\r\n        resolvedTiles.splice(0);\r\n    };\r\n}\r\nexports.createCollisionLayer = createCollisionLayer;\r\nfunction createCameraLayer(cameraToDraw) {\r\n    return function drawCameraRect(context, fromCamera) {\r\n        context.strokeStyle = 'purple';\r\n        context.strokeRect(cameraToDraw.pos.x - fromCamera.pos.x, cameraToDraw.pos.y - fromCamera.pos.y, cameraToDraw.size.x, cameraToDraw.size.y);\r\n    };\r\n}\r\nexports.createCameraLayer = createCameraLayer;\r\n\n\n/***/ }),\n/* 11 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar Compositor_1 = __webpack_require__(12);\r\nvar math_1 = __webpack_require__(1);\r\nvar TileCollider_1 = __webpack_require__(13);\r\nvar Level = /** @class */ (function () {\r\n    function Level() {\r\n        this.comp = new Compositor_1.Compositor();\r\n        this.entities = new Set();\r\n        this.tiles = new math_1.Matrix();\r\n        this.tileCollider = new TileCollider_1.TileCollider(this.tiles);\r\n        this.gravity = 1500;\r\n        this.totalTime = 0;\r\n    }\r\n    Level.prototype.update = function (deltaTime) {\r\n        var _this = this;\r\n        this.entities.forEach(function (entity) {\r\n            entity.update(deltaTime);\r\n            entity.pos.x += entity.vel.x * deltaTime;\r\n            _this.tileCollider.checkX(entity);\r\n            entity.pos.y += entity.vel.y * deltaTime;\r\n            _this.tileCollider.checkY(entity);\r\n            entity.vel.y += _this.gravity * deltaTime;\r\n        });\r\n        this.totalTime += deltaTime;\r\n    };\r\n    return Level;\r\n}());\r\nexports.Level = Level;\r\n\n\n/***/ }),\n/* 12 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar Compositor = /** @class */ (function () {\r\n    function Compositor() {\r\n        this.layers = [];\r\n    }\r\n    Compositor.prototype.draw = function (context, camera) {\r\n        this.layers.forEach(function (layer) {\r\n            layer(context, camera);\r\n        });\r\n    };\r\n    return Compositor;\r\n}());\r\nexports.Compositor = Compositor;\r\n\n\n/***/ }),\n/* 13 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar Entity_1 = __webpack_require__(0);\r\nvar TileResolver_1 = __webpack_require__(14);\r\nvar TileCollider = /** @class */ (function () {\r\n    function TileCollider(tileMatrix) {\r\n        this.tileMatrix = tileMatrix;\r\n        this.tileResolver = new TileResolver_1.TileResolver(this.tileMatrix);\r\n    }\r\n    TileCollider.prototype.checkX = function (entity) {\r\n        var pos = entity.pos, size = entity.size, vel = entity.vel;\r\n        var x;\r\n        if (vel.x > 0) {\r\n            x = pos.x + size.x;\r\n        }\r\n        else if (vel.x < 0) {\r\n            x = pos.x;\r\n        }\r\n        else {\r\n            return;\r\n        }\r\n        var matches = this.tileResolver.searchByRange(x, x, pos.y, pos.y + size.y);\r\n        if (!matches)\r\n            return;\r\n        matches.forEach(function (match) {\r\n            if (match.tile.type !== 'ground')\r\n                return;\r\n            if (vel.x > 0) {\r\n                if (pos.x + size.x > match.x1) {\r\n                    pos.x = match.x1 - size.x;\r\n                    vel.x = 0;\r\n                }\r\n            }\r\n            else if (vel.x < 0) {\r\n                if (pos.x < match.x2) {\r\n                    pos.x = match.x2;\r\n                    vel.x = 0;\r\n                }\r\n            }\r\n        });\r\n    };\r\n    TileCollider.prototype.checkY = function (entity) {\r\n        var pos = entity.pos, size = entity.size, vel = entity.vel;\r\n        var y;\r\n        if (vel.y > 0) {\r\n            y = pos.y + size.y;\r\n        }\r\n        else if (vel.y < 0) {\r\n            y = pos.y;\r\n        }\r\n        else {\r\n            return;\r\n        }\r\n        var matches = this.tileResolver.searchByRange(pos.x, pos.x + size.x, y, y);\r\n        if (!matches)\r\n            return;\r\n        matches.forEach(function (match) {\r\n            if (match.tile.type !== 'ground')\r\n                return;\r\n            if (vel.y > 0) {\r\n                if (pos.y + size.y > match.y1) {\r\n                    pos.y = match.y1 - size.y;\r\n                    vel.y = 0;\r\n                    entity.obstruct(Entity_1.Side.bottom);\r\n                }\r\n            }\r\n            else if (vel.y < 0) {\r\n                if (pos.y < match.y2) {\r\n                    pos.y = match.y2;\r\n                    vel.y = 0;\r\n                    entity.obstruct(Entity_1.Side.top);\r\n                }\r\n            }\r\n        });\r\n    };\r\n    return TileCollider;\r\n}());\r\nexports.TileCollider = TileCollider;\r\n\n\n/***/ }),\n/* 14 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar TileResolver = /** @class */ (function () {\r\n    function TileResolver(matrix, tileSize) {\r\n        if (tileSize === void 0) { tileSize = 16; }\r\n        this.matrix = matrix;\r\n        this.tileSize = tileSize;\r\n    }\r\n    TileResolver.prototype.toIndex = function (pos) {\r\n        return Math.floor(pos / this.tileSize);\r\n    };\r\n    TileResolver.prototype.toIndexRange = function (pos1, pos2) {\r\n        var pMax = Math.ceil(pos2 / this.tileSize) * this.tileSize;\r\n        var range = [];\r\n        var pos = pos1;\r\n        do {\r\n            range.push(this.toIndex(pos));\r\n            pos += this.tileSize;\r\n        } while (pos < pMax);\r\n        return range;\r\n    };\r\n    TileResolver.prototype.getByIndex = function (indexX, indexY) {\r\n        var tile = this.matrix.get(indexX, indexY);\r\n        if (tile) {\r\n            var x1 = indexX * this.tileSize;\r\n            var x2 = (indexX + 1) * this.tileSize;\r\n            var y1 = indexY * this.tileSize;\r\n            var y2 = (indexY + 1) * this.tileSize;\r\n            return { tile: tile, x1: x1, x2: x2, y1: y1, y2: y2 };\r\n        }\r\n    };\r\n    TileResolver.prototype.searchByPosition = function (posX, posY) {\r\n        return this.getByIndex(this.toIndex(posX), this.toIndex(posY));\r\n    };\r\n    TileResolver.prototype.searchByRange = function (x1, x2, y1, y2) {\r\n        var _this = this;\r\n        var matches = [];\r\n        this.toIndexRange(x1, x2).forEach(function (indexX) {\r\n            _this.toIndexRange(y1, y2).forEach(function (indexY) {\r\n                var match = _this.getByIndex(indexX, indexY);\r\n                if (match) {\r\n                    matches.push(match);\r\n                }\r\n            });\r\n        });\r\n        return matches;\r\n    };\r\n    return TileResolver;\r\n}());\r\nexports.TileResolver = TileResolver;\r\n\n\n/***/ }),\n/* 15 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar SpriteSheet = /** @class */ (function () {\r\n    function SpriteSheet(image, tileWidth, tileHeight) {\r\n        this.image = image;\r\n        this.tileWidth = tileWidth;\r\n        this.tileHeight = tileHeight;\r\n        this.tiles = new Map();\r\n        this.animations = new Map();\r\n    }\r\n    SpriteSheet.prototype.define = function (name, x, y, width, height) {\r\n        var _this = this;\r\n        var buffers = [false, true].map(function (flipped) {\r\n            var buffer = document.createElement('canvas');\r\n            buffer.width = width;\r\n            buffer.height = height;\r\n            var context = buffer.getContext('2d');\r\n            if (flipped) {\r\n                context.scale(-1, 1);\r\n                context.translate(-width, 0);\r\n            }\r\n            context.drawImage(_this.image, x, y, width, height, 0, 0, width, height);\r\n            return buffer;\r\n        });\r\n        this.tiles.set(name, buffers);\r\n    };\r\n    SpriteSheet.prototype.defineTile = function (name, x, y) {\r\n        this.define(name, x * this.tileWidth, y * this.tileHeight, this.tileWidth, this.tileHeight);\r\n    };\r\n    SpriteSheet.prototype.defineAnimation = function (name, animation) {\r\n        this.animations.set(name, animation);\r\n    };\r\n    SpriteSheet.prototype.draw = function (name, context, x, y, flip) {\r\n        if (flip === void 0) { flip = false; }\r\n        var buffers = this.tiles.get(name);\r\n        if (!buffers) {\r\n            throw new Error(\"SpriteSheet.draw(): Sprite \\\"\" + name + \"\\\" not found\");\r\n        }\r\n        context.drawImage(buffers[flip ? 1 : 0], x, y);\r\n    };\r\n    SpriteSheet.prototype.drawTile = function (name, context, x, y) {\r\n        this.draw(name, context, x * this.tileWidth, y * this.tileHeight);\r\n    };\r\n    SpriteSheet.prototype.drawAnimation = function (name, context, x, y, distance) {\r\n        var animation = this.animations.get(name);\r\n        if (!animation) {\r\n            throw new Error(\"Animation not found: \" + name);\r\n        }\r\n        this.drawTile(animation(distance), context, x, y);\r\n    };\r\n    return SpriteSheet;\r\n}());\r\nexports.SpriteSheet = SpriteSheet;\r\n\n\n/***/ }),\n/* 16 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar Keyboard_1 = __webpack_require__(17);\r\nfunction setupKeyboard(mario) {\r\n    var input = new Keyboard_1.Keyboard();\r\n    function doJump(pressed) {\r\n        if (pressed) {\r\n            mario.jump.start();\r\n        }\r\n        else {\r\n            mario.jump.cancel();\r\n        }\r\n    }\r\n    function moveRight(keyState) {\r\n        mario.go.dir += keyState === 1 ? 1 : -1;\r\n    }\r\n    function moveLeft(keyState) {\r\n        mario.go.dir += keyState === 1 ? -1 : 1;\r\n    }\r\n    function run(keyState) {\r\n        mario.turbo(keyState === 1);\r\n    }\r\n    input.addListener('KeyD', moveRight);\r\n    input.addListener('KeyA', moveLeft);\r\n    input.addListener('KeyP', doJump);\r\n    input.addListener('KeyO', run);\r\n    return input;\r\n}\r\nexports.setupKeyboard = setupKeyboard;\r\nfunction setupGamepad(mario) {\r\n    return function checkGamepadInput() {\r\n        var gamepad = navigator.getGamepads()[0];\r\n        if (gamepad) {\r\n            var movementAxis = gamepad.axes[0];\r\n            var jumping = gamepad.buttons[0].pressed || gamepad.buttons[1].pressed;\r\n            var running = gamepad.buttons[2].pressed || gamepad.buttons[3].pressed;\r\n            // factor in deadzone\r\n            if (Math.abs(movementAxis) < 0.5) {\r\n                movementAxis = 0;\r\n            }\r\n            if (jumping) {\r\n                mario.jump.start();\r\n            }\r\n            else {\r\n                mario.jump.cancel();\r\n            }\r\n            mario.go.dir = movementAxis;\r\n            mario.turbo(running);\r\n        }\r\n    };\r\n}\r\nexports.setupGamepad = setupGamepad;\r\n\n\n/***/ }),\n/* 17 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar Keyboard = /** @class */ (function () {\r\n    function Keyboard() {\r\n        /** current pressed state per key */\r\n        this.keyStates = new Map();\r\n        /** callback functions per keycode */\r\n        this.keyListeners = new Map();\r\n    }\r\n    Keyboard.prototype.addListener = function (code, callback) {\r\n        this.keyListeners.set(code, callback);\r\n        this.keyStates.set(code, 0);\r\n    };\r\n    Keyboard.prototype.listenTo = function (target) {\r\n        var _this = this;\r\n        var keyEvents = ['keydown', 'keyup'];\r\n        keyEvents.forEach(function (eventName) {\r\n            target.addEventListener(eventName, function (event) {\r\n                _this.handleEvent(event);\r\n            });\r\n        });\r\n    };\r\n    Keyboard.prototype.handleEvent = function (event) {\r\n        if (event.repeat)\r\n            return;\r\n        var listener = this.keyListeners.get(event.code);\r\n        var keyState = event.type === 'keydown' ? 1 : 0;\r\n        if (listener) {\r\n            this.keyStates.set(event.code, keyState);\r\n            listener(keyState);\r\n            event.preventDefault();\r\n        }\r\n    };\r\n    return Keyboard;\r\n}());\r\nexports.Keyboard = Keyboard;\r\n\n\n/***/ }),\n/* 18 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\n\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar Timer = /** @class */ (function () {\r\n    function Timer(deltaTime) {\r\n        if (deltaTime === void 0) { deltaTime = 1 / 60; }\r\n        var _this = this;\r\n        this.deltaTime = deltaTime;\r\n        this.accumulatedTime = 0;\r\n        this.lastTime = 0;\r\n        this.update = function (dt) { };\r\n        this.updateProxy = function (time) {\r\n            _this.accumulatedTime += (time - _this.lastTime) / 1000;\r\n            _this.accumulatedTime = Math.min(_this.accumulatedTime, 1);\r\n            while (_this.accumulatedTime > _this.deltaTime) {\r\n                _this.update(_this.deltaTime);\r\n                _this.accumulatedTime -= _this.deltaTime;\r\n            }\r\n            _this.enqueue();\r\n            _this.lastTime = time;\r\n        };\r\n    }\r\n    Timer.prototype.start = function () {\r\n        this.enqueue();\r\n    };\r\n    Timer.prototype.enqueue = function () {\r\n        requestAnimationFrame(this.updateProxy);\r\n    };\r\n    return Timer;\r\n}());\r\nexports.Timer = Timer;\r\n\n\n/***/ })\n/******/ ]);\n\n\n// WEBPACK FOOTER //\n// build.js"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 4);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 7a1fd5f41afdb69d3074","import { Vec2 } from './math'\n\nexport enum Side {\n  top,\n  bottom,\n}\n\nexport abstract class Trait {\n  constructor(public NAME: string) {}\n\n  abstract update(entity: Entity, deltaTime: number): void\n  obstruct(entity: Entity, side: Side) {}\n}\n\nexport abstract class Entity {\n  pos = new Vec2(0, 0)\n  vel = new Vec2(0, 0)\n  size = new Vec2(0, 0)\n\n  traits = [] as Trait[]\n\n  addTrait(trait: Trait) {\n    this.traits.push(trait)\n  }\n\n  getTrait<T extends Trait>(name: string): T {\n    const trait = this.traits.find(trait => trait.NAME === name)\n    if (!trait) throw new Error('Trait not found:' + name)\n    return trait as T\n  }\n\n  update(deltaTime: number) {\n    this.traits.forEach(trait => {\n      trait.update(this, deltaTime)\n    })\n  }\n\n  abstract draw(context: CanvasRenderingContext2D): void\n\n  obstruct(side: Side) {\n    this.traits.forEach(trait => {\n      trait.obstruct(this, side)\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/Entity.ts","export class Vec2 {\n  constructor(public x: number, public y: number) {}\n\n  set(x: number, y: number) {\n    this.x = x\n    this.y = y\n  }\n}\n\nexport class Matrix<T> {\n  grid = [] as T[][]\n\n  set(x: number, y: number, value: T) {\n    if (!this.grid[x]) {\n      this.grid[x] = []\n    }\n    this.grid[x][y] = value\n  }\n\n  get(x: number, y: number): T | void {\n    const col = this.grid[x]\n    if (col) return col[y]\n  }\n\n  forEach(callback: (value: T, x: number, y: number) => void) {\n    this.grid.forEach((column, x) => {\n      column.forEach((value, y) => {\n        callback(value, x, y)\n      })\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/math.ts","export type Animation = (distance: number) => string\n\nexport function createAnimation(\n  frames: string[],\n  frameLength: number,\n): Animation {\n  return function resolveFrame(distance: number) {\n    const frameIndex = Math.floor((distance / frameLength) % frames.length)\n    return frames[frameIndex]\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/animation.ts","import { createAnimation } from './animation'\nimport { createBackgroundLayer, createSpriteLayer } from './layers'\nimport { Level } from './Level'\nimport { BackgroundSpec, LevelSpec, SpriteSheetSpec } from './loaderTypes'\nimport { SpriteSheet } from './SpriteSheet'\n\nexport function loadImage(url: string) {\n  return new Promise<HTMLImageElement>((resolve, reject) => {\n    const image = new Image()\n\n    image.addEventListener('load', () => {\n      resolve(image)\n    })\n\n    image.addEventListener('error', event => {\n      reject(`Could not load image from ${url}`)\n    })\n\n    image.src = url\n  })\n}\n\nfunction loadJSON<T>(url: string): Promise<T> {\n  return fetch(url).then(res => res.json())\n}\n\nfunction createTiles(level: Level, backgrounds: BackgroundSpec[]) {\n  function applyRange(\n    background: BackgroundSpec,\n    xStart: number,\n    xLength: number,\n    yStart: number,\n    yLength: number,\n  ) {\n    const xEnd = xStart + xLength\n    const yEnd = yStart + yLength\n    for (let x = xStart; x < xEnd; x++) {\n      for (let y = yStart; y < yEnd; y++) {\n        level.tiles.set(x, y, {\n          name: background.sprite,\n          type: background.type,\n        })\n      }\n    }\n  }\n\n  backgrounds.forEach(background => {\n    background.ranges.forEach(range => {\n      if (range.length === 4) {\n        const [xStart, xLength, yStart, yLength] = range\n        applyRange(background, xStart, xLength, yStart, yLength)\n      } else if (range.length === 3) {\n        const [xStart, xLength, yStart] = range\n        applyRange(background, xStart, xLength, yStart, 1)\n      } else if (range.length === 2) {\n        const [xStart, yStart] = range\n        applyRange(background, xStart, 1, yStart, 1)\n      }\n    })\n  })\n}\n\nexport async function loadSpriteSheet(name: string) {\n  const url = `/public/sprites/${name}.json`\n  const sheetSpec = await loadJSON<SpriteSheetSpec>(url)\n  const image = await loadImage(sheetSpec.imageURL)\n\n  const sprites = new SpriteSheet(image, sheetSpec.tileW, sheetSpec.tileH)\n\n  if (sheetSpec.tiles) {\n    sheetSpec.tiles.forEach(tileSpec => {\n      const [x, y] = tileSpec.index\n      sprites.defineTile(tileSpec.name, x, y)\n    })\n  }\n\n  if (sheetSpec.frames) {\n    sheetSpec.frames.forEach(frameSpec => {\n      const [x, y, width, height] = frameSpec.rect\n      sprites.define(frameSpec.name, x, y, width, height)\n    })\n  }\n\n  if (sheetSpec.animations) {\n    sheetSpec.animations.forEach(animSpec => {\n      const animation = createAnimation(animSpec.frames, animSpec.frameLength)\n      sprites.defineAnimation(animSpec.name, animation)\n    })\n  }\n\n  return sprites\n}\n\nexport async function loadLevel(name: string) {\n  const levelSpec = await loadJSON<LevelSpec>(`/public/levels/${name}.json`)\n  const backgroundSprites = await loadSpriteSheet(levelSpec.spriteSheet)\n\n  const level = new Level()\n\n  createTiles(level, levelSpec.backgrounds)\n\n  const backgroundLayer = createBackgroundLayer(level, backgroundSprites)\n  level.comp.layers.push(backgroundLayer)\n\n  const spriteLayer = createSpriteLayer(level.entities)\n  level.comp.layers.push(spriteLayer)\n\n  return level\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/loaders.ts","import { Camera } from './Camera'\nimport { createMario } from './entities'\nimport { setupGamepad, setupKeyboard } from './input'\nimport { loadLevel } from './loaders'\nimport { Timer } from './Timer'\n\nasync function main() {\n  const canvas = document.getElementById('screen') as HTMLCanvasElement\n  const context = canvas.getContext('2d')!\n  const [mario, level] = await Promise.all([createMario(), loadLevel('1-1')])\n  const camera = new Camera()\n\n  context.imageSmoothingEnabled = false\n  context.mozImageSmoothingEnabled = false\n  context.webkitImageSmoothingEnabled = false\n\n  mario.pos.set(64, 64)\n  level.entities.add(mario)\n\n  const input = setupKeyboard(mario)\n  input.listenTo(window)\n\n  const checkGamepadInput = setupGamepad(mario)\n\n  const timer = new Timer()\n\n  timer.update = function update(deltaTime) {\n    level.update(deltaTime)\n\n    if (mario.pos.x > 100) {\n      camera.pos.x = mario.pos.x - 100\n    }\n\n    checkGamepadInput()\n\n    context.save()\n    context.scale(3, 3)\n    level.comp.draw(context, camera)\n    context.restore()\n\n    drawControls(context)\n  }\n\n  timer.start()\n}\n\n// TODO: consider turning into a text layer, maybe\nfunction drawControls(context: CanvasRenderingContext2D) {\n  const text = `\n    Controls:\n\n      Keyboard:\n        A - Move Left\n        D - Move Right\n        P - Jump\n        O - Run\n\n      Gamepad:\n        Left Stick - Move Left/Right\n        A/B - Jump\n        X/Y - Run\n  `\n\n  const lines = text.split(/[\\r\\n]/)\n\n  context.save()\n\n  context.font = '20px Roboto, sans-serif'\n  context.textAlign = 'left'\n  context.textBaseline = 'top'\n  context.fillStyle = 'white'\n\n  lines.forEach((line, index) => {\n    const offset = index * 24\n    context.fillText(line, 0, 0 + offset)\n  })\n\n  context.restore()\n}\n\nmain().catch(console.error)\n\n\n\n// WEBPACK FOOTER //\n// ./src/main.ts","import { Vec2 } from './math'\n\nexport class Camera {\n  pos = new Vec2(0, 0)\n  size = new Vec2(256, 224)\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/Camera.ts","import { Mario } from './entities/Mario'\nimport { loadSpriteSheet } from './loaders'\n\nexport async function createMario() {\n  return new Mario(await loadSpriteSheet('mario'))\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/entities.ts","import { createAnimation } from '../animation'\nimport { Entity } from '../Entity'\nimport { SpriteSheet } from '../SpriteSheet'\nimport { Go } from '../traits/Go'\nimport { Jump } from '../traits/Jump'\n\nconst FAST_DRAG = 1 / 5000\nconst SLOW_DRAG = 1 / 1000\n\nexport class Mario extends Entity {\n  jump = new Jump()\n  go = new Go()\n\n  runAnimation = createAnimation(['run-1', 'run-2', 'run-3'], 8)\n\n  constructor(private sprites: SpriteSheet) {\n    super()\n    this.size.set(14, 16)\n\n    this.addTrait(this.jump)\n    this.addTrait(this.go)\n\n    this.go.dragFactor = SLOW_DRAG\n  }\n\n  resolveAnimationFrame() {\n    if (this.jump.falling) {\n      return 'jump'\n    }\n\n    if (this.go.distance > 0) {\n      if (\n        (this.vel.x > 0 && this.go.dir < 0) ||\n        (this.vel.x < 0 && this.go.dir > 0)\n      ) {\n        return 'brake'\n      }\n\n      return this.runAnimation(this.go.distance)\n    }\n    return 'idle'\n  }\n\n  draw(context: CanvasRenderingContext2D) {\n    this.sprites.draw(\n      this.resolveAnimationFrame(),\n      context,\n      0,\n      0,\n      this.go.heading < 0,\n    )\n  }\n\n  turbo(turboState: boolean) {\n    this.go.dragFactor = turboState ? FAST_DRAG : SLOW_DRAG\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/entities/Mario.ts","import { Entity, Trait } from '../Entity'\nimport { Jump } from './Jump'\n\nexport class Go extends Trait {\n  dir = 0\n  acceleration = 400\n  distance = 0\n  heading = 1\n  dragFactor = 1 / 5000\n  deceleration = 300\n\n  constructor() {\n    super('go')\n  }\n\n  update(entity: Entity, deltaTime: number) {\n    const absX = Math.abs(entity.vel.x)\n\n    if (this.dir !== 0) {\n      entity.vel.x += this.acceleration * this.dir * deltaTime\n\n      const jump = entity.getTrait<Jump>('jump')\n      if (jump) {\n        if (jump.falling === false) {\n          this.heading = this.dir\n        }\n      } else {\n        this.heading = this.dir\n      }\n    } else if (entity.vel.x !== 0) {\n      const decel = Math.min(absX, this.deceleration * deltaTime)\n      entity.vel.x += -Math.sign(entity.vel.x) * decel\n    } else {\n      this.distance = 0\n    }\n    const drag = this.dragFactor * entity.vel.x * absX\n    entity.vel.x -= drag\n\n    this.distance += absX * deltaTime\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/traits/Go.ts","import { Entity, Side, Trait } from '../Entity'\n\nexport class Jump extends Trait {\n  duration = 0.3\n  velocity = 200\n  engageTime = 0\n  ready = 0\n  requestTime = 0\n  gracePeriod = 0.1\n  speedBoost = 0.3\n\n  constructor() {\n    super('jump')\n  }\n\n  start() {\n    this.requestTime = this.gracePeriod\n  }\n\n  cancel() {\n    this.engageTime = 0\n    this.requestTime = 0\n  }\n\n  update(entity: Entity, deltaTime: number) {\n    if (this.requestTime > 0) {\n      if (this.ready > 0) {\n        this.engageTime = this.duration\n        this.requestTime = 0\n      }\n\n      this.requestTime -= deltaTime\n    }\n\n    if (this.engageTime > 0) {\n      entity.vel.y = -(this.velocity + Math.abs(entity.vel.x) * this.speedBoost)\n      this.engageTime -= deltaTime\n    }\n\n    this.ready -= 1\n  }\n\n  obstruct(entity: Entity, side: Side) {\n    if (side === Side.bottom) {\n      this.ready = 1\n    } else if (side === Side.top) {\n      this.cancel()\n    }\n  }\n\n  get falling() {\n    return this.ready < 0\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/traits/Jump.ts","import { Camera } from './Camera'\nimport { Entity } from './Entity'\nimport { Level } from './Level'\nimport { SpriteSheet } from './SpriteSheet'\n\nexport function createBackgroundLayer(level: Level, sprites: SpriteSheet) {\n  const { tiles } = level\n  const { tileResolver } = level.tileCollider\n\n  const buffer = document.createElement('canvas')\n  buffer.width = 256 + 16\n  buffer.height = 240\n\n  const context = buffer.getContext('2d')!\n\n  let startIndex: number\n  let endIndex: number\n\n  function drawTiles(drawFrom: number, drawTo: number) {\n    // if (drawFrom === startIndex && drawTo === endIndex) return\n    startIndex = drawFrom\n    endIndex = drawTo\n\n    for (let x = startIndex; x <= endIndex; x++) {\n      const col = tiles.grid[x]\n      if (col) {\n        col.forEach((tile, y) => {\n          if (sprites.animations.has(tile.name)) {\n            sprites.drawAnimation(\n              tile.name,\n              context,\n              x - startIndex,\n              y,\n              level.totalTime,\n            )\n          } else {\n            sprites.drawTile(tile.name, context, x - startIndex, y)\n          }\n        })\n      }\n    }\n  }\n\n  return function drawBackgroundLayer(\n    context: CanvasRenderingContext2D,\n    camera: Camera,\n  ) {\n    const drawWidth = tileResolver.toIndex(camera.size.x)\n    const drawFrom = tileResolver.toIndex(camera.pos.x)\n    const drawTo = drawFrom + drawWidth\n    drawTiles(drawFrom, drawTo)\n\n    context.drawImage(buffer, -camera.pos.x % 16, -camera.pos.y)\n  }\n}\n\nexport function createSpriteLayer(\n  entities: Set<Entity>,\n  width = 64,\n  height = 64,\n) {\n  const spriteBuffer = document.createElement('canvas')\n  spriteBuffer.width = width\n  spriteBuffer.height = height\n\n  const spriteBufferContext = spriteBuffer.getContext('2d')!\n\n  return function drawSpriteLayer(\n    context: CanvasRenderingContext2D,\n    camera: Camera,\n  ) {\n    entities.forEach(entity => {\n      spriteBufferContext.clearRect(0, 0, width, height)\n\n      entity.draw(spriteBufferContext)\n\n      context.drawImage(\n        spriteBuffer,\n        entity.pos.x - camera.pos.x,\n        entity.pos.y - camera.pos.y,\n      )\n    })\n  }\n}\n\nexport function createCollisionLayer(level: Level) {\n  const tileResolver = level.tileCollider.tileResolver\n  const tileSize = tileResolver.tileSize\n  const resolvedTiles = [] as Array<{ x: number; y: number }>\n\n  const getByIndexOriginal = tileResolver.getByIndex\n\n  tileResolver.getByIndex = function getByIndexFake(x: number, y: number) {\n    resolvedTiles.push({ x, y })\n    return getByIndexOriginal.call(tileResolver, x, y)\n  }\n\n  return function drawCollision(\n    context: CanvasRenderingContext2D,\n    camera: Camera,\n  ) {\n    context.strokeStyle = 'blue'\n\n    resolvedTiles.forEach(({ x, y }) => {\n      context.strokeRect(\n        x * tileSize - camera.pos.x,\n        y * tileSize - camera.pos.y,\n        tileSize,\n        tileSize,\n      )\n    })\n\n    level.entities.forEach(entity => {\n      context.strokeRect(\n        entity.pos.x - camera.pos.x,\n        entity.pos.y - camera.pos.y,\n        entity.size.x,\n        entity.size.y,\n      )\n    })\n\n    resolvedTiles.splice(0)\n  }\n}\n\nexport function createCameraLayer(cameraToDraw: Camera) {\n  return function drawCameraRect(\n    context: CanvasRenderingContext2D,\n    fromCamera: Camera,\n  ) {\n    context.strokeStyle = 'purple'\n    context.strokeRect(\n      cameraToDraw.pos.x - fromCamera.pos.x,\n      cameraToDraw.pos.y - fromCamera.pos.y,\n      cameraToDraw.size.x,\n      cameraToDraw.size.y,\n    )\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/layers.ts","import { Compositor } from './Compositor'\nimport { Entity } from './Entity'\nimport { Matrix } from './math'\nimport { TileCollider } from './TileCollider'\n\nexport type LevelTile = {\n  name: string\n  type: string\n}\n\nexport class Level {\n  comp = new Compositor()\n  entities = new Set<Entity>()\n  tiles = new Matrix<LevelTile>()\n  tileCollider = new TileCollider(this.tiles)\n\n  gravity = 1500\n  totalTime = 0\n\n  update(deltaTime: number) {\n    this.entities.forEach(entity => {\n      entity.update(deltaTime)\n\n      entity.pos.x += entity.vel.x * deltaTime\n      this.tileCollider.checkX(entity)\n\n      entity.pos.y += entity.vel.y * deltaTime\n      this.tileCollider.checkY(entity)\n\n      entity.vel.y += this.gravity * deltaTime\n    })\n\n    this.totalTime += deltaTime\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/Level.ts","import { Camera } from './Camera'\n\nexport type LayerFunction = (\n  context: CanvasRenderingContext2D,\n  camera: Camera,\n) => void\n\nexport class Compositor {\n  layers = [] as LayerFunction[]\n\n  draw(context: CanvasRenderingContext2D, camera: Camera) {\n    this.layers.forEach(layer => {\n      layer(context, camera)\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/Compositor.ts","import { Entity, Side } from './Entity'\nimport { LevelTile } from './Level'\nimport { Matrix } from './math'\nimport { TileResolver } from './TileResolver'\n\nexport class TileCollider {\n  tileResolver = new TileResolver(this.tileMatrix)\n\n  constructor(public tileMatrix: Matrix<LevelTile>) {}\n\n  checkX(entity: Entity) {\n    const { pos, size, vel } = entity\n\n    let x\n    if (vel.x > 0) {\n      x = pos.x + size.x\n    } else if (vel.x < 0) {\n      x = pos.x\n    } else {\n      return\n    }\n\n    const matches = this.tileResolver.searchByRange(x, x, pos.y, pos.y + size.y)\n\n    if (!matches) return\n\n    matches.forEach(match => {\n      if (match.tile.type !== 'ground') return\n\n      if (vel.x > 0) {\n        if (pos.x + size.x > match.x1) {\n          pos.x = match.x1 - size.x\n          vel.x = 0\n        }\n      } else if (vel.x < 0) {\n        if (pos.x < match.x2) {\n          pos.x = match.x2\n          vel.x = 0\n        }\n      }\n    })\n  }\n\n  checkY(entity: Entity) {\n    const { pos, size, vel } = entity\n\n    let y\n    if (vel.y > 0) {\n      y = pos.y + size.y\n    } else if (vel.y < 0) {\n      y = pos.y\n    } else {\n      return\n    }\n\n    const matches = this.tileResolver.searchByRange(pos.x, pos.x + size.x, y, y)\n\n    if (!matches) return\n\n    matches.forEach(match => {\n      if (match.tile.type !== 'ground') return\n\n      if (vel.y > 0) {\n        if (pos.y + size.y > match.y1) {\n          pos.y = match.y1 - size.y\n          vel.y = 0\n\n          entity.obstruct(Side.bottom)\n        }\n      } else if (vel.y < 0) {\n        if (pos.y < match.y2) {\n          pos.y = match.y2\n          vel.y = 0\n\n          entity.obstruct(Side.top)\n        }\n      }\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/TileCollider.ts","import { LevelTile } from './Level'\nimport { Matrix } from './math'\n\nexport type TileResolverMatch = {\n  tile: LevelTile\n  x1: number\n  x2: number\n  y1: number\n  y2: number\n}\n\nexport class TileResolver {\n  constructor(public matrix: Matrix<LevelTile>, public tileSize = 16) {}\n\n  toIndex(pos: number) {\n    return Math.floor(pos / this.tileSize)\n  }\n\n  toIndexRange(pos1: number, pos2: number) {\n    const pMax = Math.ceil(pos2 / this.tileSize) * this.tileSize\n    const range = [] as number[]\n    let pos = pos1\n\n    do {\n      range.push(this.toIndex(pos))\n      pos += this.tileSize\n    } while (pos < pMax)\n\n    return range\n  }\n\n  getByIndex(indexX: number, indexY: number): TileResolverMatch | void {\n    const tile = this.matrix.get(indexX, indexY)\n    if (tile) {\n      const x1 = indexX * this.tileSize\n      const x2 = (indexX + 1) * this.tileSize\n      const y1 = indexY * this.tileSize\n      const y2 = (indexY + 1) * this.tileSize\n      return { tile, x1, x2, y1, y2 }\n    }\n  }\n\n  searchByPosition(posX: number, posY: number) {\n    return this.getByIndex(this.toIndex(posX), this.toIndex(posY))\n  }\n\n  searchByRange(x1: number, x2: number, y1: number, y2: number) {\n    const matches = [] as TileResolverMatch[]\n\n    this.toIndexRange(x1, x2).forEach(indexX => {\n      this.toIndexRange(y1, y2).forEach(indexY => {\n        const match = this.getByIndex(indexX, indexY)\n        if (match) {\n          matches.push(match)\n        }\n      })\n    })\n\n    return matches\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/TileResolver.ts","import { Animation } from './animation'\n\nexport class SpriteSheet {\n  tiles = new Map<string, HTMLCanvasElement[]>()\n  animations = new Map<string, Animation>()\n\n  constructor(\n    public image: HTMLImageElement,\n    public tileWidth: number,\n    public tileHeight: number,\n  ) {}\n\n  define(name: string, x: number, y: number, width: number, height: number) {\n    const buffers = [false, true].map(flipped => {\n      const buffer = document.createElement('canvas')\n      buffer.width = width\n      buffer.height = height\n\n      const context = buffer.getContext('2d')!\n\n      if (flipped) {\n        context.scale(-1, 1)\n        context.translate(-width, 0)\n      }\n\n      context.drawImage(this.image, x, y, width, height, 0, 0, width, height)\n\n      return buffer\n    })\n\n    this.tiles.set(name, buffers)\n  }\n\n  defineTile(name: string, x: number, y: number) {\n    this.define(\n      name,\n      x * this.tileWidth,\n      y * this.tileHeight,\n      this.tileWidth,\n      this.tileHeight,\n    )\n  }\n\n  defineAnimation(name: string, animation: Animation) {\n    this.animations.set(name, animation)\n  }\n\n  draw(\n    name: string,\n    context: CanvasRenderingContext2D,\n    x: number,\n    y: number,\n    flip = false,\n  ) {\n    const buffers = this.tiles.get(name)\n    if (!buffers) {\n      throw new Error(`SpriteSheet.draw(): Sprite \"${name}\" not found`)\n    }\n    context.drawImage(buffers[flip ? 1 : 0], x, y)\n  }\n\n  drawTile(\n    name: string,\n    context: CanvasRenderingContext2D,\n    x: number,\n    y: number,\n  ) {\n    this.draw(name, context, x * this.tileWidth, y * this.tileHeight)\n  }\n\n  drawAnimation(\n    name: string,\n    context: CanvasRenderingContext2D,\n    x: number,\n    y: number,\n    distance: number,\n  ) {\n    const animation = this.animations.get(name)\n    if (!animation) {\n      throw new Error(`Animation not found: ${name}`)\n    }\n    this.drawTile(animation(distance), context, x, y)\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/SpriteSheet.ts","import { Mario } from './entities/Mario'\nimport { Keyboard } from './Keyboard'\n\nexport function setupKeyboard(mario: Mario) {\n  const input = new Keyboard()\n\n  function doJump(pressed: number) {\n    if (pressed) {\n      mario.jump.start()\n    } else {\n      mario.jump.cancel()\n    }\n  }\n\n  function moveRight(keyState: number) {\n    mario.go.dir += keyState === 1 ? 1 : -1\n  }\n\n  function moveLeft(keyState: number) {\n    mario.go.dir += keyState === 1 ? -1 : 1\n  }\n\n  function run(keyState: number) {\n    mario.turbo(keyState === 1)\n  }\n\n  input.addListener('KeyD', moveRight)\n  input.addListener('KeyA', moveLeft)\n  input.addListener('KeyP', doJump)\n  input.addListener('KeyO', run)\n\n  return input\n}\n\nexport function setupGamepad(mario: Mario) {\n  return function checkGamepadInput() {\n    const gamepad = navigator.getGamepads()[0]\n\n    if (gamepad) {\n      let movementAxis = gamepad.axes[0]\n      const jumping = gamepad.buttons[0].pressed || gamepad.buttons[1].pressed\n      const running = gamepad.buttons[2].pressed || gamepad.buttons[3].pressed\n\n      // factor in deadzone\n      if (Math.abs(movementAxis) < 0.5) {\n        movementAxis = 0\n      }\n\n      if (jumping) {\n        mario.jump.start()\n      } else {\n        mario.jump.cancel()\n      }\n\n      mario.go.dir = movementAxis\n      mario.turbo(running)\n    }\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/input.ts","export type KeyListener = (keyState: number) => void\n\nexport class Keyboard {\n  /** current pressed state per key */\n  keyStates = new Map<string, number>()\n\n  /** callback functions per keycode */\n  keyListeners = new Map<string, KeyListener>()\n\n  addListener(code: string, callback: KeyListener) {\n    this.keyListeners.set(code, callback)\n    this.keyStates.set(code, 0)\n  }\n\n  listenTo(target: EventTarget) {\n    const keyEvents = ['keydown', 'keyup']\n    keyEvents.forEach(eventName => {\n      target.addEventListener(eventName, event => {\n        this.handleEvent(event as KeyboardEvent)\n      })\n    })\n  }\n\n  private handleEvent(event: KeyboardEvent) {\n    if (event.repeat) return\n\n    const listener = this.keyListeners.get(event.code)\n    const keyState = event.type === 'keydown' ? 1 : 0\n    if (listener) {\n      this.keyStates.set(event.code, keyState)\n      listener(keyState)\n      event.preventDefault()\n    }\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/Keyboard.ts","export class Timer {\n  private accumulatedTime = 0\n  private lastTime = 0\n\n  constructor(private deltaTime = 1 / 60) {}\n\n  update = (dt: number) => {}\n\n  start() {\n    this.enqueue()\n  }\n\n  private enqueue() {\n    requestAnimationFrame(this.updateProxy)\n  }\n\n  private updateProxy = (time: number) => {\n    this.accumulatedTime += (time - this.lastTime) / 1000\n    this.accumulatedTime = Math.min(this.accumulatedTime, 1)\n\n    while (this.accumulatedTime > this.deltaTime) {\n      this.update(this.deltaTime)\n      this.accumulatedTime -= this.deltaTime\n    }\n\n    this.enqueue()\n\n    this.lastTime = time\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/Timer.ts"],"sourceRoot":""}